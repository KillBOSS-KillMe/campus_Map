<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
  <title>电子围栏</title>
  <link rel="stylesheet" href="./css/reset.css" />
  <link rel="stylesheet" href="./css/map.css" />
  
</head>

<body class="fanceDom">
  <div class="mapCon" id="container"></div>
  <div id="fanceCon">
    <div class="topInfo" @click="selFence = true">
      <span>{{userInfo.fenceName}}</span>
      <img src="./image/right.png" alt="">
    </div>
    <div class="editButton">
      <!-- <button onclick="polyEditor.open()"> -->
      <button @click="openPolyEditor">
        <img src="./image/startEdit.png" alt="">
        开始编辑
      </button>
      <!-- <button onclick="polyEditor.close()"> -->
      <button @click="closePolyEditor">
        <img src="./image/endEdit.png" alt="">
        结束编辑
      </button>
    </div>
  </div>
</body>
<script src="./js/public.js"></script>
<script src="./js/vue.min.js"></script>
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://webapi.amap.com/maps?v=1.4.15&key=b1e64030afdd4f85f35e3da7ffb33078&plugin=AMap.PolyEditor"></script>
<script src="https://webapi.amap.com/maps?v=1.4.15&key=b1e64030afdd4f85f35e3da7ffb33078&plugin=AMap.Autocomplete&plugin=AMap.Geocoder"></script>
<script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"></script>
<script src="./js/demoutils.js"></script>
<!-- <script src="./js/fance.js"></script> -->
<script>
  let userInfo = getPageData()
  console.log(userInfo)
  // `${url}?token=${token}&fenceName=${fenceName}&deviceInfo=${deviceInfo}&alarmType=${alarmType}&statusSys=${statusSys}`
  userInfo['token'] = 'eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyQ29kZSI6Im51bGxfemp4aiIsImxvZ2luQ29kZSI6IjEzMzU5MjAxODQzIiwibW9iaWxlIjoiIiwidXNlck5hbWUiOiIxMzM1OTIwMTg0MyIsInVzZXJUeXBlIjoibWVtYmVyIiwiaWF0IjoxNTk0NTI0Mjg5fQ.Tec2zF7P0Ng52j6F9VGLuzGGozkM2ikAWvqq2n8-FWc'
  new Vue({
    el: '#fanceCon',
    data: {
      userInfo: userInfo,
      fenceNodeInfo: {},
    },
    mounted() {
      // 获取用户信息
      // this.getUserInfo()
      axiosInit()
      // 获取围栏列表
      this.getFenceList()
    },
    methods: {
      goPage(e) {
        let url = e.target.dataset.url;
        window.location.href = url
      },
      getFenceList() {
        this.fenceList = [
          {name: '围栏1', id: '1'},
          {name: '围栏2', id: '1'},
          {name: '围栏3', id: '1'},
          {name: '围栏4', id: '1'},
          {name: '围栏5', id: '1'},
        ]
        
        axios.get(`/geo/fence/list`)
          .then(res => {
            if (res.status == 200) {
              let list = res.data.payload
              for (let i = 0; i < list.length;i++) {
                let itemNode = {}
                console.log(itemNode)
                this.fenceList.push(itemNode)
              }
              this.fenceList = list
              markersShow(this.fenceList)
            }
          })
          .catch(function (error) { // 请求失败处理
            console.log(error);
          });
      },
      openPolyEditor() {
        polyEditor.open()
      },
      closePolyEditor() {
        polyEditor.close()
      }
    }
  })
  var map = new AMap.Map("container", {
      center: [116.400274, 39.905812],
      zoom: 14
  });

  var path = [
      [116.403322, 39.920255],
      [116.410703, 39.897555],
      [116.402292, 39.892353],
      [116.389846, 39.891365]
  ]

  var polygon = new AMap.Polygon({
      path: path,
      strokeColor: "#FF33FF", 
      strokeWeight: 6,
      strokeOpacity: 0.2,
      fillOpacity: 0.4,
      fillColor: '#1791fc',
      zIndex: 50,
  })

  map.add(polygon)
  // 缩放地图到合适的视野级别
  map.setFitView([ polygon ])

  // var polyEditor = new AMap.PolyEditor(map, polygon)

  // polyEditor.on('addnode', function(event) {
  //     log.info('触发事件：addnode')
  // })

  // polyEditor.on('adjust', function(event) {
  //     log.info('触发事件：adjust')
  // })

  // polyEditor.on('removenode', function(event) {
  //     log.info('触发事件：removenode')
  // })

  // polyEditor.on('end', function(event) {
  //     log.info('触发事件： end')
  //     // event.target 即为编辑后的多边形对象
  // })

  //为地图注册click事件获取鼠标点击出的经纬度坐标
  var clickEventListener = map.on('click', function(e) {
        // document.getElementById("lnglat").value = e.lnglat.getLng() + ',' + e.lnglat.getLat();

        // if (marker) {
        //     marker.setMap(null);
        //     marker = null;
        // }
        addMarker(e.lnglat.getLng(),e.lnglat.getLat());
        //这边是数组
        // var lnglatXY=[e.lnglat.getLng(),e.lnglat.getLat()];
        // regeocoder(lnglatXY);
    });

    var auto = new AMap.Autocomplete({
        input: "tipinput"
    });

    //注册监听，当选中某条记录时会触发
    AMap.event.addListener(auto, "select", select);
    function select(e) {
        var lng = e.poi.location.lng;
        var lat = e.poi.location.lat;
        console.log(e.poi.location.lng);
        if (e.poi && e.poi.location) {
            map.setZoom(15);
            map.setCenter(e.poi.location);
            addMarker(lng,lat);
        }
    }

    var marker;
    // 实例化点标记
    function addMarker(lng,lat) {
        marker = new AMap.Marker({
            icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",
            position: [lng, lat]
        });
        marker.setMap(map);
    }
</script>

</html>