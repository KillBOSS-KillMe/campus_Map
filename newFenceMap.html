<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
  <title>电子围栏</title>
  <link rel="stylesheet" href="./css/reset.css" />
  <link rel="stylesheet" href="./css/map.css" />

</head>

<body class="fanceDom">
  <div class="mapCon" id="container"></div>
  <div id="fanceCon">
    <div class="topInfo" @click="selFence = true">
      <span>{{userInfo.fenceName}}</span>
      <img src="./image/right.png" alt="">
    </div>
    <div class="editButton">
      <!-- <button onclick="polyEditor.open()"> -->
      <button @click="openPolyEditor">
        <img src="./image/startEdit.png" alt="">
        开始编辑
      </button>
      <!-- <button onclick="polyEditor.close()"> -->
      <button @click="closePolyEditor">
        <img src="./image/endEdit.png" alt="">
        结束编辑
      </button>
    </div>
  </div>
</body>
<script src="./js/public.js"></script>
<script src="./js/vue.min.js"></script>
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://webapi.amap.com/maps?v=1.4.15&key=b1e64030afdd4f85f35e3da7ffb33078&plugin=AMap.PolyEditor"></script>
<script src="https://webapi.amap.com/maps?v=1.4.15&key=b1e64030afdd4f85f35e3da7ffb33078&plugin=AMap.Autocomplete&plugin=AMap.Geocoder"></script>
<script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"></script>
<script src="./js/demoutils.js"></script>
<!-- <script src="./js/fance.js"></script> -->
<script>
  let userInfo = getPageData()
  console.log(userInfo)
  // `${url}?token=${token}&fenceName=${fenceName}&deviceInfo=${deviceInfo}&alarmType=${alarmType}&statusSys=${statusSys}`
  userInfo['token'] = 'eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyQ29kZSI6Im51bGxfemp4aiIsImxvZ2luQ29kZSI6IjEzMzU5MjAxODQzIiwibW9iaWxlIjoiIiwidXNlck5hbWUiOiIxMzM1OTIwMTg0MyIsInVzZXJUeXBlIjoibWVtYmVyIiwiaWF0IjoxNTk0NTI0Mjg5fQ.Tec2zF7P0Ng52j6F9VGLuzGGozkM2ikAWvqq2n8-FWc'
  new Vue({
    el: '#fanceCon',
    data: {
      userInfo: userInfo,
      fenceNodeInfo: {},
    },
    mounted() {
      // 获取用户信息
      // this.getUserInfo()
      axiosInit()
    },
    methods: {
      goPage(e) {
        let url = e.target.dataset.url;
        window.location.href = url
      },
      openPolyEditor() {
        polyEditor.open()
      },
      closePolyEditor() {
        polyEditor.close()
      }
    }
  })



  var map, geolocation;
  //加载地图，调用浏览器定位服务
  map = new AMap.Map('container', {
    resizeEnable: true
  });
  map.plugin('AMap.Geolocation', function () {
    geolocation = new AMap.Geolocation({
      enableHighAccuracy: true, //是否使用高精度定位，默认:true
      timeout: 10000, //超过10秒后停止定位，默认：无穷大
      buttonOffset: new AMap.Pixel(10, 20), //定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
      zoomToAccuracy: true, //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
      buttonPosition: 'RB'
    });
    map.addControl(geolocation);
    geolocation.getCurrentPosition();
    AMap.event.addListener(geolocation, 'complete', onComplete); //返回定位信息
    AMap.event.addListener(geolocation, 'error', onError); //返回定位出错信息
  });
  //解析定位结果
  function onComplete(data) {
    var str = [];
    console.log(data.position);
    var lat = data.position.getLat();
    var lng = data.position.getLng();
    console.log(lat)
    console.log(lng)
    AMap.Map("container", {
      center: [lng, lat],
      zoom: 14
    });
  }
  //解析定位错误信息
  function onError(data) {
    console.log('err');
  }

  // map = new AMap.Map("container", {
  //   center: [116.400274, 39.905812],
  //   zoom: 14
  // });
  var polygon = undefined;
  var path = []
  var marker;
  var polyEditor = undefined

  //为地图注册click事件获取鼠标点击出的经纬度坐标
  var clickEventListener = map.on('click', (e) => {
    if (path.length >= 3) {
      console.log(polygon)
      if (!polygon) {
        polygon = new AMap.Polygon({
        path: path,
        strokeColor: "#FF33FF",
        strokeWeight: 6,
        strokeOpacity: 0.2,
        fillOpacity: 0.4,
        fillColor: '#1791fc',
        zIndex: 50
      })
      map.add(polygon)
      // 缩放地图到合适的视野级别
      map.setFitView([polygon])
      }
      polyEditor = new AMap.PolyEditor(map, polygon)

      polyEditor.on('addnode', function(event) {
          log.info('触发事件：addnode')
      })

      polyEditor.on('adjust', function(event) {
          log.info('触发事件：adjust')
      })

      polyEditor.on('removenode', function(event) {
          log.info('触发事件：removenode')
      })

      polyEditor.on('end', function(event) {
          log.info('触发事件： end')
          // event.target 即为编辑后的多边形对象
      })
      return false;
    }
    // 获取经纬度放入path数组
    path.push([e.lnglat.getLng(), e.lnglat.getLat()])
    addMarker(e.lnglat.getLng(), e.lnglat.getLat());
  });

  var auto = new AMap.Autocomplete({
    input: "tipinput"
  });

  //注册监听，当选中某条记录时会触发
  AMap.event.addListener(auto, "select", select);
  function select(e) {
    var lng = e.poi.location.lng;
    var lat = e.poi.location.lat;
    if (e.poi && e.poi.location) {
      map.setZoom(15);
      map.setCenter(e.poi.location);
      addMarker(lng, lat);
    }
  }

  
  // 实例化点标记
  function addMarker(lng, lat) {
    marker = new AMap.Marker({
      icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",
      position: [lng, lat]
    });
    marker.setMap(map);
  }
</script>

</html>